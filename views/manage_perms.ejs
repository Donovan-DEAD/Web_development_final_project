<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Permisos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/styles/manage_perms.css">
    <link rel="stylesheet" href="styles/navbar.css">
</head>
<body>
    <%- include('partials/navbar', { username: username, current_page: 'manage_perms', user: user }) %>

    <div class="container mt-5">
        <h1>Gestionar Permisos de Usuario</h1>
        <hr>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">Email</th>
                        <th scope="col">Nombre</th>
                        <th scope="col">Permiso</th>
                        <th scope="col">Acción</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                    <% users.forEach(user => { %>
                        <%- include('partials/_user_perms_row', { user: user }) %>
                    <% }); %>
                </tbody>
            </table>
        </div>

        <% if (total_pages > 1) { %>
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <% for (let i = 1; i <= total_pages; i++) { %>
                        <li class="page-item <%= i === pagination_page ? 'active' : '' %>">
                            <a class="page-link" href="/perms/users?page=<%= i %>"><%= i %></a>
                        </li>
                    <% } %>
                </ul>
            </nav>
        <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userTableBody = document.getElementById('user-table-body');

            userTableBody.addEventListener('change', async (event) => {
                if (event.target.classList.contains('permission-select')) {
                    const selectElement = event.target;
                    const row = selectElement.closest('tr');
                    const userId = row.getAttribute('data-user-id');
                    const newPermission = selectElement.value;
                    const originalPermission = selectElement.getAttribute('data-original-permission');

                    try {
                        const response = await axios.post('/api/perms/users', {
                            id: userId,
                            perm: newPermission
                        });

                        if (response.status === 200) {
                            alert('Permiso actualizado con éxito:', response.data);
                            selectElement.setAttribute('data-original-permission', newPermission);
                        }
                    } catch (error) {
                        alert('Error al actualizar el permiso:', error);
                        selectElement.value = originalPermission;
                    }
                }
            });

            userTableBody.addEventListener('click', async (event) => {
                if (event.target.classList.contains('delete-user-btn')) {
                    const buttonElement = event.target;
                    const row = buttonElement.closest('tr');
                    const userId = row.getAttribute('data-user-id');
                    const userEmail = row.cells[0].textContent;

                    if (confirm(`¿Estás seguro de que quieres eliminar al usuario ${userEmail}?`)) {
                        try {
                            const response = await axios.delete('/api/perms/users', {
                                data: { id: userId }
                            });

                            if (response.status === 200) {
                                console.log('Usuario eliminado con éxito');
                                row.remove();
                            }
                        } catch (error) {
                            console.error('Error al eliminar el usuario:', error)
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
